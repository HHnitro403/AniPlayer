<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:models="using:Aniplayer.Core.Models"
             xmlns:controls="using:AniPlayer.UI.Views.Controls"
             xmlns:local="using:AniPlayer.UI"
             mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="700"
             x:Class="AniPlayer.UI.ShowInfoPage"
             x:DataType="local:ShowInfoPage">

    <ScrollViewer HorizontalScrollBarVisibility="Disabled">
        <StackPanel Margin="32,24" Spacing="24">

            <!-- Navigation -->
            <StackPanel Orientation="Horizontal" Spacing="8">
                <Button x:Name="BackButton" Content="Back"
                        Padding="12,6"
                        Click="BackButton_Click"/>
                <Button x:Name="RefreshMetadataButton" Content="Refresh Metadata"
                        Padding="12,6"
                        IsVisible="False"
                        Click="RefreshMetadata_Click"/>
            </StackPanel>

            <!-- Header: cover + info -->
            <Grid ColumnDefinitions="180,*" MinHeight="260">
                <!-- Cover image placeholder -->
                <Border Background="{DynamicResource BgBase}" CornerRadius="{DynamicResource RadiusM}"
                        Width="170" Height="240"
                        VerticalAlignment="Top">
                    <Panel>
                        <Image x:Name="CoverImage" Stretch="UniformToFill"/>
                        <TextBlock x:Name="CoverPlaceholder"
                                   Text="No Cover"
                                   Foreground="{DynamicResource TextSecondary}" FontSize="14" Opacity="0.5"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Panel>
                </Border>

                <!-- Series info -->
                <StackPanel Grid.Column="1" Margin="24,0,0,0" Spacing="8">
                    <TextBlock x:Name="TitleText" Text="Series Title"
                               FontSize="26" FontWeight="Bold"
                               TextWrapping="Wrap"
                               Foreground="{DynamicResource TextPrimary}"/>
                    <TextBlock x:Name="AlternateTitleText"
                               FontSize="14" Opacity="0.5"
                               TextWrapping="Wrap"
                               Foreground="{DynamicResource TextPrimary}"/>
                    <StackPanel Orientation="Horizontal" Spacing="16" Margin="0,8,0,0">
                        <TextBlock x:Name="EpisodeCountText" Text="? episodes"
                                   FontSize="13" Opacity="0.7"
                                   Foreground="{DynamicResource TextPrimary}"/>
                        <TextBlock x:Name="StatusBadge" Text="Unknown"
                                   FontSize="13" Opacity="0.7"
                                   Foreground="{DynamicResource TextPrimary}"/>
                        <TextBlock x:Name="ScoreText" FontSize="13" Opacity="0.7"
                                   Foreground="{DynamicResource TextPrimary}"/>
                    </StackPanel>
                    <WrapPanel x:Name="GenresPanel" Margin="0,8,0,0"/>
                    <TextBlock x:Name="SynopsisText"
                               FontSize="14" Opacity="0.8"
                               TextWrapping="Wrap"
                               MaxHeight="120"
                               Margin="0,8,0,0"
                               Foreground="{DynamicResource TextPrimary}"/>
                </StackPanel>
            </Grid>

            <Separator Margin="0,8"/>

            <!-- Playback Preferences Section -->
            <Border Background="{DynamicResource BgSurface}" CornerRadius="{DynamicResource RadiusM}" Padding="20,16" BorderBrush="{DynamicResource BgBase}" BorderThickness="1">
                <StackPanel Spacing="12">
                    <TextBlock Text="ðŸ“Š Playback Preferences" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/>

                    <!-- Current Preferences Display -->
                    <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto" Margin="0,8,0,0">
                        <TextBlock Grid.Row="0" Text="ðŸŽµ Audio:" FontSize="13" Foreground="{DynamicResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBlock x:Name="AudioPreferenceText" Grid.Row="0" Grid.Column="1" Text="Auto (not set)" FontSize="13"
                                   Foreground="{DynamicResource TextPrimary}" Margin="12,0,0,0" VerticalAlignment="Center"/>
                        <Button x:Name="ResetAudioButton" Grid.Row="0" Grid.Column="2" Content="Reset" Padding="8,4" FontSize="11"
                                Focusable="False" Click="ResetAudioPreference_Click" CornerRadius="4"/>

                        <TextBlock Grid.Row="1" Text="ðŸ’¬ Subtitles:" FontSize="13" Foreground="{DynamicResource TextSecondary}" Margin="0,8,0,0" VerticalAlignment="Center"/>
                        <TextBlock x:Name="SubtitlePreferenceText" Grid.Row="1" Grid.Column="1" Text="Auto (not set)" FontSize="13"
                                   Foreground="{DynamicResource TextPrimary}" Margin="12,8,0,0" VerticalAlignment="Center"/>
                        <Button x:Name="ResetSubtitleButton" Grid.Row="1" Grid.Column="2" Content="Reset" Padding="8,4" FontSize="11" Margin="0,8,0,0"
                                Focusable="False" Click="ResetSubtitlePreference_Click" CornerRadius="4"/>
                    </Grid>

                    <Separator Opacity="0.2" Margin="0,8"/>

                    <!-- Manual Subtitle Override Toggle -->
                    <CheckBox x:Name="ManualSubtitleToggle" Content="Enable manual subtitle override (external files)"
                              Foreground="{DynamicResource TextPrimary}" FontSize="13" IsChecked="False" Checked="ManualSubtitleToggle_Changed" Unchecked="ManualSubtitleToggle_Changed"/>

                    <!-- Manual Override Controls (collapsed by default) -->
                    <StackPanel x:Name="ManualSubtitlePanel" IsVisible="False" Spacing="12" Margin="0,8,0,0">
                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto">
                            <!-- Episode Selector -->
                            <TextBlock Grid.Row="0" Text="Select Episode:" FontSize="12" Foreground="{DynamicResource TextSecondary}" Margin="0,0,0,4"/>
                            <ComboBox x:Name="OverrideEpisodeSelector" Grid.Row="1" Grid.ColumnSpan="2" HorizontalAlignment="Stretch"
                                      SelectionChanged="OverrideEpisodeSelector_Changed"/>

                            <!-- Subtitle File Picker -->
                            <TextBlock Grid.Row="2" Text="Subtitle File:" FontSize="12" Foreground="{DynamicResource TextSecondary}" Margin="0,12,0,4"/>
                            <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Spacing="8" Margin="0,12,0,0">
                                <Button x:Name="BrowseSubtitleButton" Content="Browse..." Classes="Primary" Padding="12,6" FontSize="12"
                                        Focusable="False" Click="BrowseSubtitle_Click" CornerRadius="4"/>
                                <Button x:Name="SaveSubtitleOverrideButton" Content="Save Override" Padding="12,6" FontSize="12"
                                        Focusable="False" Click="SaveSubtitleOverride_Click" CornerRadius="4" IsEnabled="False"/>
                                <Button x:Name="ClearSubtitleOverrideButton" Content="Clear Override" Padding="12,6" FontSize="12"
                                        Focusable="False" Click="ClearSubtitleOverride_Click" CornerRadius="4"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock x:Name="SelectedSubtitlePath" Text="No file selected" FontSize="11" Foreground="{DynamicResource TextSecondary}" Margin="0,4,0,0" Opacity="0.6"/>

                        <!-- Current Overrides List -->
                        <Border Background="{DynamicResource BgBase}" CornerRadius="4" Padding="12" Margin="0,8,0,0">
                            <StackPanel Spacing="4">
                                <TextBlock Text="Active Overrides:" FontSize="12" FontWeight="SemiBold" Foreground="{DynamicResource TextSecondary}"/>
                                <ItemsControl x:Name="OverridesList" Margin="0,8,0,0">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="local:ShowInfoPage+SubtitleOverride">
                                            <Grid ColumnDefinitions="*,Auto" Margin="0,2">
                                                <TextBlock Text="{Binding DisplayText}" FontSize="11" Foreground="{DynamicResource TextPrimary}" VerticalAlignment="Center"/>
                                                <Button Content="Remove" Tag="{Binding EpisodeId}" Classes="Danger" Padding="6,3" FontSize="10" Grid.Column="1"
                                                        Focusable="False" Click="RemoveOverride_Click" CornerRadius="3"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Separator Margin="0,8"/>

            <!-- Episode list -->
            <ItemsControl x:Name="SeasonListControl" ItemsSource="{Binding SeasonGroups}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="local:ShowInfoPage+SeasonGroup">
                        <StackPanel Margin="0,0,0,10">
                            <Expander IsExpanded="{Binding IsExpanded}"
                                      HorizontalAlignment="Stretch"
                                      Background="{DynamicResource BgSurface}"
                                      BorderThickness="0"
                                      CornerRadius="{DynamicResource RadiusS}">
                                <Expander.Header>
                                    <TextBlock Text="{Binding Header}"
                                               FontSize="18"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource TextPrimary}"/>
                                </Expander.Header>

                                <ItemsControl ItemsSource="{Binding Episodes}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="models:Episode">
                                            <controls:EpisodeRow Margin="0,2" PointerPressed="OnEpisodePlayRequest" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Expander>

                            <Border Height="1"
                                    Background="{DynamicResource TextPrimary}"
                                    Opacity="0.1"
                                    Margin="10,15,10,5"/>
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

        </StackPanel>
    </ScrollViewer>
</UserControl>
